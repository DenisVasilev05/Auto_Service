{% extends 'base.html' %}
{% load static %}
{% load form_tags %}

{% block title %}Register Vehicle - Auto Service{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .vehicle-preview {
        border: 2px dashed #dee2e6;
        padding: 2rem;
        text-align: center;
        margin-bottom: 2rem;
    }

    .vehicle-preview i {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .vehicle-preview.has-image i {
        display: none;
    }

    .vehicle-preview img {
        max-width: 100%;
        max-height: 300px;
        display: none;
    }

    .vehicle-preview.has-image img {
        display: inline-block;
    }

    .form-label {
        font-weight: 500;
    }

    .form-text {
        font-size: 0.875rem;
    }

    .invalid-feedback {
        font-size: 0.875rem;
    }

    .btn-file {
        position: relative;
        overflow: hidden;
    }

    .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: inherit;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Register Your Vehicle</h2>
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <form id="vehicleForm" method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.make.id_for_label }}" class="form-label">Make</label>
                                    {{ form.make|addclass:"form-control" }}
                                    {% if form.make.errors %}
                                        <div class="text-danger">{{ form.make.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.model.id_for_label }}" class="form-label">Model</label>
                                    {{ form.model|addclass:"form-control" }}
                                    {% if form.model.errors %}
                                        <div class="text-danger">{{ form.model.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.year.id_for_label }}" class="form-label">Year</label>
                                    {{ form.year|addclass:"form-control" }}
                                    {% if form.year.errors %}
                                        <div class="text-danger">{{ form.year.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.color.id_for_label }}" class="form-label">Color</label>
                                    {{ form.color|addclass:"form-control" }}
                                    {% if form.color.errors %}
                                        <div class="text-danger">{{ form.color.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.license_plate.id_for_label }}" class="form-label">License Plate</label>
                                    {{ form.license_plate|addclass:"form-control" }}
                                    {% if form.license_plate.errors %}
                                        <div class="text-danger">{{ form.license_plate.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.vin.id_for_label }}" class="form-label">VIN</label>
                                    {{ form.vin|addclass:"form-control" }}
                                    {% if form.vin.errors %}
                                        <div class="text-danger">{{ form.vin.errors|join:", " }}</div>
                                    {% endif %}
                                    <div class="form-text">Vehicle Identification Number (17 characters)</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.registration_date.id_for_label }}" class="form-label">Registration Date</label>
                                    {{ form.registration_date|addclass:"form-control" }}
                                    {% if form.registration_date.errors %}
                                        <div class="text-danger">{{ form.registration_date.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.mileage.id_for_label }}" class="form-label">Current Mileage (km)</label>
                                    {{ form.mileage|addclass:"form-control" }}
                                    {% if form.mileage.errors %}
                                        <div class="text-danger">{{ form.mileage.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Vehicle preview placeholder -->
                        <div class="vehicle-preview mb-4">
                            <i class="fas fa-car"></i>
                            <img id="vehicleImage" alt="Vehicle preview">
                        </div>
                        <!-- Image upload -->
                        <div class="mb-4">
                            <label class="form-label">Vehicle Photo</label>
                            {{ form.image|addclass:"form-control" }}
                            <div class="form-text">Optional â€“ upload a photo of your vehicle (jpg, png).</div>
                            {% if form.image.errors %}
                                <div class="text-danger">{{ form.image.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Register Vehicle</button>
                            <a href="{% url 'service:dashboard' %}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize form validation
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('vehicleForm');
        const imageInput = document.getElementById('imageInput');
        const vehiclePreview = document.querySelector('.vehicle-preview');
        const vehicleImage = document.getElementById('vehicleImage');

        // Image preview
        imageInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    vehicleImage.src = e.target.result;
                    vehiclePreview.classList.add('has-image');
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // Form validation
        form.addEventListener('submit', function(e) {
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }
            form.classList.add('was-validated');
        });

        // VIN validation
        const vinInput = document.getElementById('vin');
        vinInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            if (this.value.length === 17) {
                validateVIN(this.value);
            }
        });

        // Year validation
        const yearInput = document.getElementById('year');
        const currentYear = new Date().getFullYear();
        yearInput.max = currentYear;
        yearInput.addEventListener('input', function() {
            const year = parseInt(this.value);
            if (year < 1900 || year > currentYear) {
                this.setCustomValidity('Please enter a valid year between 1900 and ' + currentYear);
            } else {
                this.setCustomValidity('');
            }
        });

        // License plate validation
        const licensePlateInput = document.getElementById('license_plate');
        licensePlateInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // Mileage validation
        const mileageInput = document.getElementById('mileage');
        mileageInput.addEventListener('input', function() {
            if (parseInt(this.value) < 0) {
                this.setCustomValidity('Mileage cannot be negative');
            } else {
                this.setCustomValidity('');
            }
        });
    });

    // VIN validation function
    function validateVIN(vin) {
        // This is a basic VIN validation
        // In a production environment, you might want to use a more comprehensive validation
        // or an external API to validate the VIN
        const vinInput = document.getElementById('vin');
        const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
        
        if (!vinRegex.test(vin)) {
            vinInput.setCustomValidity('Please enter a valid 17-character VIN');
        } else {
            vinInput.setCustomValidity('');
        }
    }
</script>
{% endblock %} 